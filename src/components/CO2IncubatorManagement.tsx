import React, { useState, useEffect, useMemo } from 'react';
import { CO2IncubatorTracking, CalendarEventType } from '@/types';
import { Language } from '@/types';
import { googleCalendarService, createCalendarEventFromSchedule } from '@/services/googleCalendarService';
import { useSessionContext } from '@/contexts/SessionContext';
import { useLabStateContext } from '@/contexts/AppProviders';
import { useEquipmentContext } from '@/contexts/EquipmentContext';
import { useToast } from '@/contexts/ToastContext';
import { useEquipmentActions } from '@/hooks/useEquipmentActions';

export const CO2IncubatorManagement: React.FC = () => {
  const { language, currentUser } = useSessionContext();
  const { co2IncubatorTrackingData, setCo2IncubatorTrackingData } = useLabStateContext();
  const { equipment } = useEquipmentContext();
  const { showToast } = useToast();
  const { updateCO2IncubatorTracking } = useEquipmentActions();
  const isJapanese = language === Language.JA;
  
  const [selectedIncubator, setSelectedIncubator] = useState<string | null>(null);
  const [showRecordForm, setShowRecordForm] = useState(false);
  const [formData, setFormData] = useState({
    currentLevel: 0,
    notes: ''
  });

  const co2Incubators = useMemo(() => equipment.filter(e => e.nameEN.includes('CO2 Incubator')), [equipment]);

  useEffect(() => {
    const trackedIds = new Set(co2IncubatorTrackingData.map(d => d.equipmentId));
    const newTrackingData: CO2IncubatorTracking[] = [];
    let changed = false;
    co2Incubators.forEach(inc => {
        if (!trackedIds.has(inc.id)) {
            changed = true;
            newTrackingData.push({
                id: `co2-track-${inc.id}`,
                equipmentId: inc.id,
                equipmentName: isJapanese ? inc.nameJP : inc.nameEN,
                gasType: 'CO2',
                cylinderSize: 40, // kg - default
                currentLevel: 40, // kg - full
                minimumLevel: 5, // kg
                lastMeasuredDate: new Date(),
                lastMeasuredBy: 'system',
                estimatedEmptyDate: null,
                alertTriggered: false,
                notes: 'Initial data.',
                replacementScheduled: false,
            });
        }
    });
    if (changed) {
        setCo2IncubatorTrackingData(prev => [...prev, ...newTrackingData]);
    }
  }, [co2Incubators, co2IncubatorTrackingData, setCo2IncubatorTrackingData, isJapanese]);
  

  const gasTypeLabels = {
    CO2: { jp: 'ÁÇ≠ÈÖ∏„Ç¨„Çπ (CO2)', en: 'Carbon Dioxide (CO2)' },
    N2: { jp: 'Á™íÁ¥†„Ç¨„Çπ (N2)', en: 'Nitrogen (N2)' },
    O2: { jp: 'ÈÖ∏Á¥†„Ç¨„Çπ (O2)', en: 'Oxygen (O2)' }
  };

  const calculateEstimatedEmptyDate = (
    currentLevel: number,
    cylinderSize: number,
    lastMeasuredDate: Date,
    previousLevel?: number,
    previousDate?: Date
  ): Date | null => {
    if (previousLevel === undefined || !previousDate || currentLevel >= previousLevel) return null;

    const daysDiff = Math.max(1, (lastMeasuredDate.getTime() - new Date(previousDate).getTime()) / (1000 * 60 * 60 * 24));
    const usagePerDay = (previousLevel - currentLevel) / daysDiff;

    if (usagePerDay <= 0) return null;

    const daysRemaining = currentLevel / usagePerDay;
    const emptyDate = new Date(lastMeasuredDate);
    emptyDate.setDate(emptyDate.getDate() + Math.floor(daysRemaining));

    return emptyDate;
  };

  const getWarningLevel = (currentLevel: number, minimumLevel: number, cylinderSize: number) => {
    const percentage = (currentLevel / cylinderSize) * 100;

    if (currentLevel <= minimumLevel) {
      return { level: 'critical' as const, labelJP: 'Á∑äÊÄ•‰∫§ÊèõÂøÖË¶Å', labelEN: 'Critical - Replace Now', color: 'bg-red-100 text-red-700 border-red-300', icon: 'üö®' };
    } else if (percentage <= 20) {
      return { level: 'warning' as const, labelJP: '‰∫§ÊèõÊé®Â•®', labelEN: 'Warning - Replace Soon', color: 'bg-orange-100 text-orange-700 border-orange-300', icon: '‚ö†Ô∏è' };
    } else if (percentage <= 40) {
      return { level: 'caution' as const, labelJP: 'Ë¶ÅÊ≥®ÊÑè', labelEN: 'Caution', color: 'bg-yellow-100 text-yellow-700 border-yellow-300', icon: '‚ö°' };
    }
    return { level: 'normal' as const, labelJP: 'Ê≠£Â∏∏', labelEN: 'Normal', color: 'bg-green-100 text-green-700 border-green-300', icon: '‚úì' };
  };

  const handleSubmitRecord = () => {
    if (!selectedIncubator || formData.currentLevel < 0 || !currentUser) {
      showToast(isJapanese ? 'ÂÖ•ÂäõÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ' : 'Please check input values', 'error');
      return;
    }

    const existingData = co2IncubatorTrackingData.find(t => t.equipmentId === selectedIncubator);
    
    if (existingData) {
      if (formData.currentLevel > existingData.cylinderSize) {
        showToast(isJapanese ? 'ÊÆãÈáè„Åå„Ç∑„É™„É≥„ÉÄ„ÉºÂÆπÈáè„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ' : 'Level cannot exceed cylinder size.', 'error');
        return;
      }

      const estimatedEmptyDate = calculateEstimatedEmptyDate(
        formData.currentLevel,
        existingData.cylinderSize,
        new Date(),
        existingData.currentLevel,
        new Date(existingData.lastMeasuredDate)
      );
      const warningLevel = getWarningLevel(formData.currentLevel, existingData.minimumLevel, existingData.cylinderSize);
      const updatedData: CO2IncubatorTracking = {
        ...existingData,
        previousLevel: existingData.currentLevel,
        previousDate: existingData.lastMeasuredDate,
        currentLevel: formData.currentLevel,
        lastMeasuredDate: new Date(),
        lastMeasuredBy: currentUser.id,
        estimatedEmptyDate,
        alertTriggered: (warningLevel.level === 'critical' || warningLevel.level === 'warning'),
        alertDate: (warningLevel.level === 'critical' || warningLevel.level === 'warning') && !existingData.alertTriggered ? new Date() : existingData.alertDate,
        notes: formData.notes
      };

      updateCO2IncubatorTracking(updatedData);
      showToast(isJapanese ? '„Ç¨„ÇπÊÆãÈáè„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü' : 'Gas level recorded', 'success');
      if (warningLevel.level === 'critical') {
        showToast(isJapanese ? '‚ö†Ô∏è „Ç¨„ÇπÊÆãÈáè„ÅåÂç±Èô∫„É¨„Éô„É´„Åß„ÅôÔºÅËá≥ÊÄ•‰∫§Êèõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' : '‚ö†Ô∏è Gas level critical! Replace immediately', 'error');
      }
    }
    setFormData({ currentLevel: 0, notes: '' });
    setShowRecordForm(false);
  };

  const scheduleReplacement = async (id: string, date: Date) => {
    const item = co2IncubatorTrackingData.find(t => t.id === id);
    if (!item) return;

    const calendarEvent = createCalendarEventFromSchedule(
      CalendarEventType.CO2Replacement,
      {
        jp: `CO2„Éú„É≥„Éô‰∫§Êèõ: ${item.equipmentName}`,
        en: `CO2 Cylinder Replacement: ${item.equipmentName}`
      },
      {
        jp: `${item.equipmentName}„ÅÆCO2„Éú„É≥„Éô„Çí‰∫§Êèõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁèæÂú®ÊÆãÈáè: ${item.currentLevel}kg`,
        en: `Replace CO2 cylinder for ${item.equipmentName}. Current level: ${item.currentLevel}kg`
      },
      date,
      60, // ‰∫§Êèõ‰ΩúÊ•≠„ÅØ1ÊôÇÈñì„ÇíÊÉ≥ÂÆö
      ['user-lab-manager'], // ÊñΩË®≠„Çπ„Çø„ÉÉ„Éï„Å´Ââ≤„ÇäÂΩì„Å¶
      item.id,
      [4320, 1440, 60] // 3Êó•Ââç„ÄÅ1Êó•Ââç„ÄÅ1ÊôÇÈñìÂâç„Å´„É™„Éû„Ç§„É≥„ÉÄ„Éº
    );
  
    try {
      const syncResult = await googleCalendarService.createEvent(calendarEvent, language);
      
      const updatedItem = {
        ...item,
        replacementScheduled: true,
        replacementDate: date,
        googleCalendarEventId: syncResult.success ? syncResult.googleCalendarEventId : undefined,
      };
      updateCO2IncubatorTracking(updatedItem);
      
      if (syncResult.success) {
        showToast(
          isJapanese 
            ? '‚úÖ ‰∫§Êèõ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË®≠ÂÆö„Åó„ÄÅGoogle„Ç´„É¨„É≥„ÉÄ„Éº„Å´ÁôªÈå≤„Åó„Åæ„Åó„Åü' 
            : '‚úÖ Replacement scheduled and added to Google Calendar',
          'success'
        );
      } else {
        showToast(
          isJapanese 
            ? '‚ö†Ô∏è ‰∫§Êèõ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü„Åå„ÄÅGoogle„Ç´„É¨„É≥„ÉÄ„Éº„Å∏„ÅÆÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' 
            : '‚ö†Ô∏è Replacement scheduled, but failed to sync with Google Calendar',
          'warning'
        );
      }
    } catch (error) {
      console.error('Calendar sync error:', error);
      updateCO2IncubatorTracking({ ...item, replacementScheduled: true, replacementDate: date });
      showToast(
        isJapanese 
          ? '‰∫§Êèõ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË®≠ÂÆö„Åó„Åæ„Åó„ÅüÔºà„Ç´„É¨„É≥„ÉÄ„ÉºÂêåÊúü„ÅØ„Ç™„Éï„É©„Ç§„É≥Ôºâ' 
          : 'Replacement scheduled (Calendar sync offline)',
        'info'
      );
    }
  };

  const overviewCounts = useMemo(() => {
    const counts = { normal: 0, caution: 0, warning: 0, critical: 0 };
    co2IncubatorTrackingData.forEach(t => {
      const warning = getWarningLevel(t.currentLevel, t.minimumLevel, t.cylinderSize);
      counts[warning.level]++;
    });
    return counts;
  }, [co2IncubatorTrackingData]);


  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-6">{isJapanese ? 'CO2„Ç§„É≥„Ç≠„É•„Éô„Éº„Çø„Éº „Ç¨„ÇπÁÆ°ÁêÜ' : 'CO2 Incubator Gas Management'}</h2>

      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
          <div className="text-sm text-green-600 font-medium">{isJapanese ? 'Ê≠£Â∏∏' : 'Normal'}</div>
          <div className="text-2xl font-bold text-green-700">{overviewCounts.normal}</div>
        </div>
        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
          <div className="text-sm text-yellow-600 font-medium">{isJapanese ? 'Ë¶ÅÊ≥®ÊÑè' : 'Caution'}</div>
          <div className="text-2xl font-bold text-yellow-700">{overviewCounts.caution}</div>
        </div>
        <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
          <div className="text-sm text-orange-600 font-medium">{isJapanese ? '‰∫§ÊèõÊé®Â•®' : 'Warning'}</div>
          <div className="text-2xl font-bold text-orange-700">{overviewCounts.warning}</div>
        </div>
        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
          <div className="text-sm text-red-600 font-medium">{isJapanese ? 'Á∑äÊÄ•' : 'Critical'}</div>
          <div className="text-2xl font-bold text-red-700">{overviewCounts.critical}</div>
        </div>
      </div>

      {showRecordForm && selectedIncubator && (
        <div className="bg-white p-6 rounded-lg shadow mb-6 border-2 border-blue-200">
          <h3 className="text-lg font-bold mb-4">{isJapanese ? `„Ç¨„ÇπÊÆãÈáèË®òÈå≤ (${co2IncubatorTrackingData.find(d => d.equipmentId === selectedIncubator)?.equipmentName})` : `Record Gas Level (${co2IncubatorTrackingData.find(d => d.equipmentId === selectedIncubator)?.equipmentName})`}</h3>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-2">{isJapanese ? 'ÁèæÂú®„ÅÆÊÆãÈáèÔºàkgÔºâ' : 'Current Level (kg)'} *</label>
              <input type="number" min="0" step="0.1" value={formData.currentLevel} onChange={(e) => setFormData({...formData, currentLevel: parseFloat(e.target.value) || 0})} className="w-full border rounded p-2" placeholder="0.0" />
              <p className="text-xs text-gray-500 mt-1">{isJapanese ? '„Éú„É≥„Éô„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÊÆãÈáè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' : 'Enter the level shown on the cylinder'}</p>
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">{isJapanese ? 'ÂÇôËÄÉ' : 'Notes'}</label>
              <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full border rounded p-2" rows={2} placeholder={isJapanese ? 'Ê∞ó„Å•„ÅÑ„ÅüÁÇπ„Åå„ÅÇ„Çå„Å∞Ë®òÂÖ•' : 'Optional notes'} />
            </div>
          </div>
          <div className="flex justify-end gap-2 mt-4">
            <button onClick={() => { setShowRecordForm(false); setSelectedIncubator(null); }} className="px-4 py-2 border rounded hover:bg-gray-50">{isJapanese ? '„Ç≠„É£„É≥„Çª„É´' : 'Cancel'}</button>
            <button onClick={handleSubmitRecord} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">{isJapanese ? 'Ë®òÈå≤„Åô„Çã' : 'Record'}</button>
          </div>
        </div>
      )}

      <div className="space-y-4">
        {co2IncubatorTrackingData.map(item => {
          const warningStatus = getWarningLevel(item.currentLevel, item.minimumLevel, item.cylinderSize);
          const percentage = (item.currentLevel / item.cylinderSize) * 100;

          return (
            <div key={item.id} className={`bg-white rounded-lg shadow border-l-4 ${warningStatus.color.replace('bg-', 'border-').replace('-100', '-300')}`}>
              <div className="p-6">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-2xl">{warningStatus.icon}</span>
                      <h3 className="text-xl font-bold">{item.equipmentName}</h3>
                    </div>
                    <div className="text-sm text-gray-600">{isJapanese ? gasTypeLabels[item.gasType].jp : gasTypeLabels[item.gasType].en}</div>
                  </div>
                  <span className={`px-3 py-1 text-sm font-medium rounded ${warningStatus.color}`}>{isJapanese ? warningStatus.labelJP : warningStatus.labelEN}</span>
                </div>

                <div className="mb-4">
                  <div className="flex justify-between text-sm mb-1">
                    <span className="font-medium">{isJapanese ? 'ÊÆãÈáè' : 'Current Level'}</span>
                    <span className="font-bold">{item.currentLevel.toFixed(1)} kg / {item.cylinderSize} kg ({percentage.toFixed(1)}%)</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden"><div className={`h-full transition-all duration-500 ${percentage <= 10 ? 'bg-red-500' : percentage <= 20 ? 'bg-orange-500' : percentage <= 40 ? 'bg-yellow-500' : 'bg-green-500'}`} style={{ width: `${percentage}%` }} /></div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                  <div className="bg-gray-50 p-3 rounded"><div className="text-xs text-gray-600 mb-1">{isJapanese ? 'ÊúÄÁµÇË®òÈå≤' : 'Last Measured'}</div><div className="text-sm font-medium">{new Date(item.lastMeasuredDate).toLocaleString(isJapanese ? 'ja-JP' : 'en-US')}</div></div>
                  {item.estimatedEmptyDate && (<div className="bg-gray-50 p-3 rounded"><div className="text-xs text-gray-600 mb-1">{isJapanese ? '‰∫àÊ∏¨Á©∫„ÅçÊó•' : 'Estimated Empty'}</div><div className="text-sm font-medium">{new Date(item.estimatedEmptyDate).toLocaleDateString(isJapanese ? 'ja-JP' : 'en-US')}</div></div>)}
                  {item.replacementScheduled && item.replacementDate && (
                    <div className="bg-blue-50 p-3 rounded">
                      <div className="text-xs text-blue-600 mb-1 flex items-center justify-between">
                        <span>{isJapanese ? '‰∫§Êèõ‰∫àÂÆöÊó•' : 'Replacement Scheduled'}</span>
                        {item.googleCalendarEventId && (
                          <span className="flex items-center gap-1 text-green-600">
                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                            </svg>
                            {isJapanese ? '„Ç´„É¨„É≥„ÉÄ„ÉºÂêåÊúüÊ∏à„Åø' : 'Synced'}
                          </span>
                        )}
                      </div>
                      <div className="text-sm font-medium text-blue-700">
                        {new Date(item.replacementDate).toLocaleDateString(isJapanese ? 'ja-JP' : 'en-US')}
                      </div>
                    </div>
                  )}
                </div>

                <div className="flex gap-2">
                  <button onClick={() => { setSelectedIncubator(item.equipmentId); setShowRecordForm(true); setFormData({ currentLevel: item.currentLevel, notes: '' }); }} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">{isJapanese ? 'ÊÆãÈáè„ÇíË®òÈå≤' : 'Record Level'}</button>
                  {!item.replacementScheduled && (warningStatus.level === 'warning' || warningStatus.level === 'critical') && (<button onClick={() => { const scheduledDate = new Date(); scheduledDate.setDate(scheduledDate.getDate() + 7); scheduleReplacement(item.id, scheduledDate); }} className="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">{isJapanese ? '‰∫§Êèõ‰∫àÁ¥Ñ' : 'Schedule Replacement'}</button>)}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      <div className="mt-6 p-4 bg-blue-50 rounded border border-blue-200">
        <p className="text-sm text-blue-800 mb-2">{isJapanese ? '‚Äª CO2„Ç§„É≥„Ç≠„É•„Éô„Éº„Çø„Éº„ÅÆ„Ç¨„Çπ„Éú„É≥„ÉôÊÆãÈáè„ÇíÂÆöÊúüÁöÑ„Å´Ë®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊÆãÈáè„ÅåÂ∞ë„Å™„Åè„Å™„Çã„Å®Ëá™ÂãïÁöÑ„Å´Ë≠¶Âëä„ÅåË°®Á§∫„Åï„Çå„ÄÅÁ©∫„ÅçÊó•„ÅÆ‰∫àÊ∏¨„ÅåË°å„Çè„Çå„Åæ„Åô„ÄÇ' : '‚Äª Please record the gas cylinder levels regularly. Warnings will be displayed automatically when levels are low, and empty dates will be estimated.'}</p>
        <p className="text-sm text-blue-800">{isJapanese ? 'Á∑äÊÄ•„É¨„Éô„É´„Å´ÈÅî„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅÈÄü„ÇÑ„Åã„Å´„Éú„É≥„Éô„ÅÆ‰∫§Êèõ„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' : 'When critical level is reached, please replace the cylinder immediately.'}</p>
      </div>
    </div>
  );
};

export default CO2IncubatorManagement;