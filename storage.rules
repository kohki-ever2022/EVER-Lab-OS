rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Path for chat files. roomId is the chat room ID, fileId is the unique file identifier.
    match /chat-files/{roomId}/{fileId} {
      
      // Allow read access only to members of the chat room.
      allow read: if request.auth != null && 
                     request.auth.uid in get(/databases/(default)/documents/chatRooms/$(roomId)).data.memberIds;

      // Allow write access only to authenticated members of the chat room.
      // - Must be a member of the room.
      // - File size must be less than 10MB.
      // - File type must be one of the allowed types.
      allow write: if request.auth != null && 
                      request.auth.uid in get(/databases/(default)/documents/chatRooms/$(roomId)).data.memberIds &&
                      request.resource.size < 10 * 1024 * 1024 &&
                      (request.resource.contentType.matches('image/jpeg') ||
                       request.resource.contentType.matches('image/png') ||
                       request.resource.contentType.matches('image/gif') ||
                       request.resource.contentType.matches('application/pdf') ||
                       request.resource.contentType.matches('application/msword') ||
                       request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
                       request.resource.contentType.matches('application/vnd.ms-excel') ||
                       request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') ||
                       request.resource.contentType.matches('application/zip'));
    }
  }
}
