import{l as b,b as N,r as f,u as j,e as v,d as D,P as S,f as C,i as A,j as t}from"./index-B-QOVXil.js";import{a as L}from"./App-gCA-TVeX.js";const T=()=>`snapshot-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,$=()=>{const{inventorySnapshots:a,setInventorySnapshots:e}=b(),{setAuditLogs:d}=N(),x=f.useCallback((c,i,p,l,g,y)=>{const k=T(),h=`${c}-${String(i).padStart(2,"0")}`,u={id:k,period:h,snapshotDate:new Date,consumables:p.map(n=>({id:n.id,nameJP:n.nameJP,nameEN:n.nameEN,stock:n.stock,unit:n.packageUnit||"",categoryJP:n.categoryJP,categoryEN:n.categoryEN,ownerCompanyId:n.ownerCompanyId})),createdBy:l,notes:y||""};return e(n=>[...n,u]),d(n=>[...n,{id:`audit-${Date.now()}`,action:"SNAPSHOT_CREATED",details:`Created snapshot for period ${h}`,userId:l,userName:g,timestamp:new Date}]),u},[e,d]),r=f.useCallback((c,i,p)=>{e([]),d(l=>[...l,{id:`audit-${Date.now()}`,action:"ALL_UNLOCKED",details:`Reason: ${p}`,userId:c,userName:i,timestamp:new Date}])},[e,d]),m=f.useCallback(()=>a.length===0?null:[...a].sort((c,i)=>new Date(i.snapshotDate).getTime()-new Date(c.snapshotDate).getTime())[0],[a]);return{snapshots:a,createMonthlySnapshot:x,unlockAllSnapshots:r,getLatestSnapshot:m}},P=()=>{const{currentUser:a}=j(),{t:e}=v(),d=D(),x=S(),{showToast:r}=C(),{hasPermission:m}=L(),{snapshots:c,createMonthlySnapshot:i,unlockAllSnapshots:p}=$(),{openModal:l}=A(),g=m("inventory","manage"),y=m("inventory","manage"),k=()=>{l({type:"confirmAction",props:{title:e("confirmLockTitle"),message:e("confirmLockMessage"),confirmText:e("lock"),onConfirm:()=>{if(!a){r(e("userNotFound"),"error");return}try{const s=new Date;i(s.getFullYear(),s.getMonth()+1,x,a.id,a.name),r(e("lockSuccess"),"success")}catch(s){const o=s instanceof Error?s.message:"An unknown error occurred";r(`${e("lockFailed")}: ${o}`,"error")}}}})},h=()=>{l({type:"promptAction",props:{title:e("unlockAllTitle"),message:e("unlockReasonPrompt"),inputLabel:e("unlockReason"),confirmText:e("unlock"),onConfirm:s=>{if(!a){r(e("userNotFound"),"error");return}try{p(a.id,a.name,s),r(e("unlockSuccess"),"success")}catch(o){const w=o instanceof Error?o.message:"An unknown error occurred";r(`${e("unlockFailed")}: ${w}`,"error")}}}})},u=s=>{var o;return((o=d.find(w=>w.id===s))==null?void 0:o.name)||s},n=[...c].sort((s,o)=>new Date(o.snapshotDate).getTime()-new Date(s.snapshotDate).getTime());return t.jsxs("div",{children:[t.jsx("h2",{className:"text-3xl font-bold mb-6 text-ever-black",children:e("inventoryLockManagement")}),g&&t.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md mb-8",children:[t.jsx("h3",{className:"text-lg font-bold mb-4",children:e("executeInventoryLock")}),t.jsx("p",{className:"text-sm text-gray-600 mb-4",children:e("lockDescription")}),t.jsxs("div",{className:"flex gap-4",children:[t.jsx("button",{onClick:k,className:"bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg",children:e("lockCurrentMonth")}),y&&t.jsx("button",{onClick:h,className:"bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg",children:e("unlockAll")})]})]}),t.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[t.jsx("h3",{className:"text-lg font-bold mb-4",children:e("snapshotHistory")}),t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e("period")}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e("lockDate")}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e("itemCount")}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e("executedBy")})]})}),t.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[n.map(s=>t.jsxs("tr",{children:[t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.period}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:new Date(s.snapshotDate).toLocaleString()}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.consumables.length}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:u(s.createdBy)})]},s.id)),n.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,className:"text-center py-8 text-gray-500",children:e("noSnapshots")})})]})]})})]})]})};export{P as default};
