import{L as B,p as F,a4 as K,a5 as V,a6 as W,a7 as w,x as H,a8 as X,a9 as Z,aa as ee,u as te,e as se,l as ne,m as ae,K as oe,Z as re,o as le,v as ie,P as ce,d as de,f as ue,r as v,j as t}from"./index-B-QOVXil.js";import{r as me}from"./App-gCA-TVeX.js";import{M as pe}from"./MarkdownRenderer-DbuJuX1V.js";import{u as ge}from"./useAdminActions-oUyNlHWx.js";const he=(l,n,d)=>{const{reservations:u,equipment:m,consumables:o,sds:q,certificates:U,invoices:M,incidents:z,language:N}=d,S=N===B.JA,p=new Date(l,n-1,1),E=new Date(l,n,0,23,59,59),i=u.filter(e=>{const a=new Date(e.startTime);return a>=p&&a<=E}),T=m.map(e=>{const a=i.filter(C=>C.equipmentId===e.id&&C.status===F.Completed),Q=a.reduce((C,$)=>$.actualStartTime&&$.actualEndTime?C+(new Date($.actualEndTime).getTime()-new Date($.actualStartTime).getTime())/6e4:C,0);return{equipmentName:S?e.nameJP:e.nameEN,totalHours:Math.round(Q/60),reservationCount:a.length}}).sort((e,a)=>a.totalHours-e.totalHours).slice(0,K),g=T.reduce((e,a)=>e+a.totalHours,0),D=m.length*V*W,h=D>0?Math.round(g/D*100):0,P=o.filter(e=>e.isHazardous),k=e=>!e.isHazardous||!e.designatedQuantity||!e.packageSize||e.designatedQuantity===0?0:e.stock*e.packageSize/e.designatedQuantity,y=P.reduce((e,a)=>e+k(a),0),x=o.filter(e=>e.stock<=0),f=x.slice(0,w).map(e=>S?e.nameJP:e.nameEN);if(x.length>w){const e=x.length-w;f.push(H("moreItems",N,{count:e}))}const b=o.filter(e=>e.stock>0&&e.stock<=e.lowStockThreshold),R=b.slice(0,w).map(e=>S?e.nameJP:e.nameEN);if(b.length>w){const e=b.length-w;R.push(H("moreItems",N,{count:e}))}const G=q.filter(e=>e.status===X.Pending).length,J=U.filter(e=>e.status===Z.Expired).length,L=z.filter(e=>new Date(e.reportedAt)>=p&&new Date(e.reportedAt)<=E),A=M.filter(e=>e.period===`${l}-${String(n).padStart(2,"0")}`),j=A.reduce((e,a)=>e+a.totalAmount,0),I=new Date(l,n-2,1),s=`${I.getFullYear()}-${String(I.getMonth()+1).padStart(2,"0")}`,c=M.filter(e=>e.period===s).reduce((e,a)=>e+a.totalAmount,0),_=c>0?(j-c)/c*100:j>0?100:0,O={};A.forEach(e=>{O[e.companyName]=(O[e.companyName]||0)+e.totalAmount});const Y=Object.entries(O).map(([e,a])=>({tenantName:e,amount:a})).sort((e,a)=>a.amount-e.amount).slice(0,ee);return{period:`${l}-${String(n).padStart(2,"0")}`,equipmentUsage:{totalReservations:i.length,completedReservations:i.filter(e=>e.status===F.Completed).length,cancelledReservations:i.filter(e=>e.status===F.Cancelled).length,noShowCount:i.filter(e=>e.status===F.NoShow).length,totalUsageHours:g,overallUtilizationRate:h,byEquipment:T},inventory:{hazardousRatio:parseFloat(y.toFixed(3)),stockoutItems:f,reorderNeededItems:R},compliance:{pendingSDSCount:G,expiredCertificatesCount:J,incidentsCount:L.length},financial:{totalRevenue:j,previousMonthRevenue:c,revenueChangePercentage:parseFloat(_.toFixed(1)),byTenant:Y}}},xe=async(l,n)=>{const d=H("langNameForPrompt",n),u=H("reportGenerationFailed",n),m=`
あなたはBSL-2対応の共同利用型研究施設の運営コンサルタントです。
以下のJSONデータから、施設運営者（施設責任者、ラボマネージャー）向けの包括的な月次レポートを${d}で生成してください。

【レポート構成】
1.  **エグゼクティブサマリー:** 当月の最も重要なハイライトと注意点を3〜5行で簡潔にまとめてください。
2.  **機器利用状況の分析:** 全体的な稼働率、予約のキャンセル・No-Show率について分析し、特に利用率が高い・低い機器トップ3を挙げてください。傾向から読み取れることを考察してください。
3.  **在庫管理状況:** 危険物比率の安全性評価、在庫切れ・低在庫品目の影響について言及してください。
4.  **コンプライアンス状況:** 未レビューのSDS、期限切れ証明書、発生したインシデントの数を示し、潜在的なリスクを指摘してください。
5.  **財務サマリー:** 総請求額と前月比の増減について分析し、テナント別の請求額も示してください。
6.  **改善提案:** 上記の分析に基づき、コスト削減、運営効率化、安全性向上のための具体的なアクションアイテムを3〜5項目提案してください。

【データ】
\`\`\`json
${JSON.stringify(l,null,2)}
\`\`\`

【出力形式】
Markdown形式で、見出し、太字、箇条書きを効果的に使用して、プロフェッショナルで読みやすいレポートを作成してください。各セクションで具体的な数値を引用し、専門的な洞察を加えてください。
  `,o=await me.generateText(m,n);return!o||o.includes("Error:")||o.includes("エラー:")?(console.error("Failed to generate monthly report:",o),u):o},Ne=()=>{const{currentUser:l}=te(),{t:n,language:d}=se(),{monthlyReports:u}=ne(),{sds:m,ehsIncidents:o}=ae(),{invoices:q}=oe(),{certificates:U}=re(),M=le(),z=ie(),N=ce(),S=de(),{showToast:p}=ue(),{addMonthlyReport:E}=ge(),[i,T]=v.useState(new Date().getFullYear()),[g,D]=v.useState(new Date().getMonth()),[h,P]=v.useState(!1),[k,y]=v.useState(""),[x,f]=v.useState(""),[b,R]=v.useState(""),G=async()=>{if(!l)return;P(!0),y(""),f("");const s=`${i}-${String(g+1).padStart(2,"0")}`;R(s);try{const r={reservations:M,equipment:z,consumables:N,sds:m,certificates:U,invoices:q,users:S,incidents:o,language:d},c=he(i,g+1,r),_=await xe(c,d);y(_),(await E({period:s,generatedAt:new Date,generatedByUserId:l.id,markdownContent:_})).success===!1&&p(n("reportSaveFailed"),"error")}catch(r){console.error(r);const c=r instanceof Error?r.message:"An unknown error occurred.";f(`${n("reportGenerateErrorMsg")}: ${c}`),p(n("reportGenerateError"),"error")}finally{P(!1)}},J=()=>{window.print()},L=()=>{p(n("emailNotSupported"),"warning")},A=s=>{y(s.markdownContent),R(s.period),f("")},j=Array.from({length:5},(s,r)=>new Date().getFullYear()-r),I=Array.from({length:12},(s,r)=>({value:r,label:new Date(0,r).toLocaleString(d,{month:"long"})}));return t.jsxs("div",{children:[t.jsx("h2",{className:"text-3xl font-bold mb-6 text-ever-black no-print",children:n("monthlyOperationsReport")}),t.jsxs("div",{className:"flex flex-col md:flex-row gap-8",children:[t.jsxs("aside",{className:"md:w-1/4 no-print",children:[t.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md mb-8",children:[t.jsx("h3",{className:"text-lg font-bold mb-4",children:n("generateNewReport")}),t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsx("select",{value:i,onChange:s=>T(parseInt(s.target.value)),className:"p-2 border rounded-md",children:j.map(s=>t.jsx("option",{value:s,children:s},s))}),t.jsx("select",{value:g,onChange:s=>D(parseInt(s.target.value)),className:"p-2 border rounded-md",children:I.map(s=>t.jsx("option",{value:s.value,children:s.label},s.value))}),t.jsx("button",{onClick:G,disabled:h,className:"bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400",children:n(h?"generating":"generateReport")})]}),h&&t.jsx("p",{className:"text-sm text-gray-600 mt-4",children:n("generatingWait")})]}),t.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[t.jsx("h3",{className:"text-lg font-bold mb-4",children:n("reportHistory")}),t.jsxs("ul",{className:"space-y-2 max-h-96 overflow-y-auto",children:[u.map(s=>t.jsx("li",{children:t.jsxs("button",{onClick:()=>A(s),className:`w-full text-left p-3 rounded-md transition-colors ${b===s.period?"bg-blue-100 text-blue-800":"hover:bg-gray-100"}`,children:[t.jsx("span",{className:"font-semibold",children:s.period}),t.jsx("span",{className:"block text-xs text-gray-500",children:new Date(s.generatedAt).toLocaleDateString()})]})},s.id)),u.length===0&&t.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:n("noHistory")})]})]})]}),t.jsxs("main",{className:"flex-1",children:[x&&t.jsx("div",{className:"p-4 bg-red-100 text-red-700 rounded-md mb-8",children:x}),k?t.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4 border-b pb-4 no-print",children:[t.jsxs("h3",{className:"text-2xl font-bold",children:[n("reportForPeriod"),": ",b]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:J,className:"bg-white hover:bg-gray-100 text-gray-800 font-semibold py-1 px-3 border border-gray-300 rounded shadow text-sm",children:n("downloadPdf")}),t.jsx("button",{onClick:L,className:"bg-white hover:bg-gray-100 text-gray-800 font-semibold py-1 px-3 border border-gray-300 rounded shadow text-sm",children:n("shareViaEmail")})]})]}),t.jsx("div",{id:"report-preview",className:"printable-area",children:t.jsx(pe,{markdown:k})})]}):!h&&t.jsx("div",{className:"bg-white p-12 rounded-lg shadow-md text-center",children:t.jsx("p",{className:"text-gray-500",children:n("selectReportPrompt")})})]})]})]})};export{Ne as default};
