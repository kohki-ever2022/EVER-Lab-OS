import{u as T,e as I,d as R,c as k,f as A,r as d,j as s}from"./index-B-QOVXil.js";import{p as E,q as U}from"./App-gCA-TVeX.js";const J=()=>{var b;const{currentUser:t}=T(),{t:i,isJapanese:p}=I(),u=R(),l=k(),{showToast:N}=A(),[c,w]=d.useState([]),[n,y]=d.useState(null),[x,h]=d.useState([]),[o,f]=d.useState(""),m=d.useRef(null);d.useEffect(()=>{if(!t||!l.subscribeToChatRooms)return;const e=l.subscribeToChatRooms(t.id,a=>{w(a)});return()=>e()},[t,l]);const S=()=>{var e;(e=m.current)==null||e.scrollIntoView({behavior:"smooth"})};d.useEffect(()=>{if(!n||!t||!l.subscribeToChatMessages){h([]);return}const e=c.find(r=>r.id===n);e&&e.unreadCount[t.id]>0&&l.markMessageAsRead(n,t.id);const a=l.subscribeToChatMessages(n,r=>{h(r)});return()=>a()},[n,l,t,c]),d.useEffect(()=>{S()},[x]);const g=async()=>{if(!o.trim()||!n||!t||!l.sendChatMessage)return;const e=await l.sendChatMessage({roomId:n,senderId:t.id,content:U(o),createdAt:new Date});e.success===!1?N(`${i("failedToSend")}: ${e.error.message}`,"error"):f("")},C=e=>{var a;return((a=u.find(r=>r.id===e))==null?void 0:a.name)||"Unknown User"},M=e=>{var a;return(a=u.find(r=>r.id===e))==null?void 0:a.imageUrl};return t?s.jsxs("div",{className:"flex h-[calc(100vh-10rem)] bg-white rounded-lg shadow-xl overflow-hidden",children:[s.jsxs("div",{className:"w-full md:w-1/3 border-r bg-gray-50 flex flex-col",children:[s.jsx("div",{className:"p-4 border-b bg-white flex-shrink-0",children:s.jsx("h2",{className:"text-xl font-bold",children:i("messages")})}),s.jsx("div",{className:"overflow-y-auto",children:s.jsx("div",{className:"divide-y",children:c.map(e=>s.jsxs("div",{onClick:()=>y(e.id),className:`p-4 cursor-pointer hover:bg-gray-100 ${n===e.id?"bg-ever-blue-light":""}`,children:[s.jsxs("div",{className:"flex justify-between items-start mb-1",children:[s.jsx("div",{className:"font-semibold text-gray-800",children:e.subject}),e.unreadCount[t.id]>0&&s.jsx("span",{className:"bg-red-500 text-white text-xs font-semibold px-2 py-0.5 rounded-full",children:e.unreadCount[t.id]})]}),s.jsx("div",{className:"text-sm text-gray-600 truncate",children:e.lastMessage}),s.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(e.lastMessageAt).toLocaleString(p?"ja-JP":"en-US",{dateStyle:"short",timeStyle:"short"})})]},e.id))})})]}),s.jsx("div",{className:"w-full md:w-2/3 flex flex-col",children:n?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"p-4 border-b flex-shrink-0",children:s.jsx("h3",{className:"font-bold",children:(b=c.find(e=>e.id===n))==null?void 0:b.subject})}),s.jsx("div",{className:"flex-1 p-4 overflow-y-auto",children:s.jsxs("div",{className:"space-y-4",children:[x.map((e,a)=>{const r=e.senderId===t.id,j=C(e.senderId),v=M(e.senderId);return s.jsxs("div",{className:`flex items-start gap-3 ${r?"flex-row-reverse":""}`,children:[s.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-300 flex-shrink-0 flex items-center justify-center",children:v?s.jsx("img",{src:v,alt:j,className:"w-full h-full rounded-full object-cover"}):j.charAt(0)}),s.jsxs("div",{className:`p-3 rounded-lg max-w-xs md:max-w-md ${r?"bg-ever-blue text-white":"bg-gray-200"}`,children:[s.jsx("p",{className:"text-sm",children:e.content}),s.jsx("div",{className:`text-xs mt-1 ${r?"text-blue-100":"text-gray-500"}`,children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]},e.id||a)}),s.jsx("div",{ref:m})]})}),s.jsx("div",{className:"p-4 border-t bg-white flex-shrink-0",children:s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{type:"text",value:o,onChange:e=>f(e.target.value),onKeyPress:e=>e.key==="Enter"&&g(),placeholder:i("typeAMessage"),className:"flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-ever-blue"}),s.jsx("button",{onClick:g,className:"bg-ever-blue text-white rounded-full p-2 w-10 h-10 flex items-center justify-center",children:s.jsx(E,{})})]})})]}):s.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:s.jsx("p",{children:i("selectChatToStart")})})})]}):null};export{J as default};
