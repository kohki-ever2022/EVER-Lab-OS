import{c as F,P as N,d as j,u as S,e as L,r as d,R as E,n as T,Q as O,f as U,J as D,j as l}from"./index-B-QOVXil.js";import{h as A,i as R,s as m,H as I}from"./App-gCA-TVeX.js";const J=()=>{const o=F(),i=N(),c=j(),{currentUser:x}=S(),{t:f}=L(),{addAuditLog:g}=A(),{addNotification:u}=R(),w=d.useCallback(async s=>{try{if(s.isLocked)throw new Error(f("inventoryLockedUpdate"));const t=i.find(p=>p.id===s.id),v=await o.updateConsumable(m(s));if(v.success&&t&&u&&c){const p=s.stock>0&&s.stock<=s.lowStockThreshold,y=t.stock>t.lowStockThreshold;p&&y&&c.filter(b=>b.role===E.LabManager||b.role===E.FacilityDirector).forEach(b=>{u({recipientUserId:b.id,type:T.LowStock,priority:"MEDIUM",titleJP:"低在庫アラート",titleEN:"Low Stock Alert",messageJP:`消耗品「${s.nameJP}」の在庫が閾値を下回りました。`,messageEN:`Stock for "${s.nameEN}" is below the threshold.`,actionUrl:"#/reorderSuggestions"})})}return v}catch(t){return{success:!1,error:t instanceof Error?t:new Error(String(t))}}},[f,o,i,u,c]),a=d.useCallback(async s=>{try{if(i.some(t=>t.isLocked))throw new Error(f("inventoryLockedAdd"));return await o.createConsumable(m(s))}catch(t){return{success:!1,error:t instanceof Error?t:new Error(String(t))}}},[i,f,o]),r=d.useCallback(async s=>{try{const t=i.find(v=>v.id===s);if(t!=null&&t.isLocked)throw new Error(f("inventoryLockedDelete"));return await o.deleteConsumable(s)}catch(t){return{success:!1,error:t instanceof Error?t:new Error(String(t))}}},[i,f,o]),n=d.useCallback(async s=>{const t=i.find(y=>y.id===s.consumableId);if(!t)return{success:!1,error:new Error("Consumable not found.")};if(t.stock<s.quantity)return{success:!1,error:new Error("Insufficient stock.")};if(t.isLocked)return{success:!1,error:new Error("Inventory is locked.")};const v={...s,totalPrice:s.quantity*s.unitPrice,orderDate:new Date,status:O.Ordered},p=await o.createOrder(m(v));return p.success&&g("ORDER_CREATE",`User ${s.userId} ordered ${s.quantity} of consumable ${s.consumableId}.`),p},[o,g,i]);return d.useMemo(()=>({updateConsumable:w,addConsumable:a,deleteConsumable:r,addOrder:n}),[w,a,r,n])},M=()=>{const o=F(),i=j(),c=d.useCallback(a=>{if(!a)return[];const r=i.find(n=>n.id===a);return(r==null?void 0:r.favoriteConsumableIds)||[]},[i]),x=d.useCallback((a,r)=>c(a).includes(r),[c]),f=async(a,r)=>{const n=i.find(s=>s.id===a);n&&await o.updateUser({...n,favoriteConsumableIds:r})},g=d.useCallback(async(a,r)=>{if(!a||!r)return;const n=c(a);n.includes(r)||await f(a,[...n,r])},[c,i,o]),u=d.useCallback(async(a,r)=>{if(!a||!r)return;const n=c(a);n.includes(r)&&await f(a,n.filter(s=>s!==r))},[c,i,o]),w=d.useCallback(async(a,r)=>{if(!a||!r)return;const n=c(a),t=n.includes(r)?n.filter(v=>v!==r):[...n,r];await f(a,t)},[c,i,o]);return{getFavorites:c,isFavorite:x,addFavorite:g,removeFavorite:u,toggleFavorite:w}},Q=()=>{const{currentUser:o}=S(),i=N(),{showToast:c}=U(),{addOrder:x}=J(),{getFavorites:f,toggleFavorite:g}=M(),{t:u,isJapanese:w}=L(),[a,r]=d.useState({}),[n,s]=d.useState(null),[t,v]=d.useState(null),p=d.useMemo(()=>o?f(o.id):[],[o,f]),y=D.useMemo(()=>i.filter(e=>p.includes(e.id)),[i,p]);d.useEffect(()=>{const e={};y.forEach(h=>{e[h.id]=1}),r(e)},[y]);const C=async e=>{if(o){v(e);try{await g(o.id,e)}catch{c("Failed to update favorites","error")}finally{v(null)}}},b=(e,h)=>{h>=1&&r(k=>({...k,[e]:h}))},P=async e=>{if(!o)return;s(e.id);const h=a[e.id]||1;if(e.price===void 0){c(u("itemCannotBePurchased"),"error"),s(null);return}const k=await x({userId:o.id,companyId:o.companyId,consumableId:e.id,quantity:h,unitPrice:e.price});k.success===!1?c(k.error.message,"error"):c(u("orderPlacedSuccessfully"),"success"),s(null)};return o?l.jsxs("div",{children:[l.jsx("h2",{className:"text-3xl font-bold mb-6 text-ever-black",children:u("favorites")}),y.length===0?l.jsx("div",{className:"text-center py-12 bg-white rounded-lg shadow",children:l.jsx("p",{className:"text-gray-500",children:u("noFavorites")})}):l.jsx("div",{className:"space-y-4",children:y.map(e=>l.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-md flex items-center justify-between",children:[l.jsxs("div",{className:"flex-1 min-w-0",children:[l.jsx("p",{className:"font-bold truncate",children:w?e.nameJP:e.nameEN}),l.jsxs("p",{className:"text-sm text-gray-600",children:[u("stock")," ",e.stock]}),e.price!==void 0&&l.jsxs("p",{className:"text-sm font-semibold text-ever-purple",children:["¥",e.price.toLocaleString()]})]}),l.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 flex-shrink-0 ml-4",children:[e.type==="sales"&&e.price!==void 0&&l.jsxs(l.Fragment,{children:[l.jsx("input",{type:"number",value:a[e.id]||1,onChange:h=>b(e.id,parseInt(h.target.value,10)),className:"w-16 p-1 border rounded",min:"1",disabled:n===e.id}),l.jsx("button",{onClick:()=>P(e),className:"bg-ever-blue text-white font-bold py-2 px-4 rounded-lg text-sm disabled:bg-gray-400",disabled:n===e.id,children:n===e.id?u("ordering"):u("order")})]}),l.jsx("button",{onClick:()=>C(e.id),className:"p-2 rounded-full hover:bg-red-100 transition-colors disabled:opacity-50",title:u("removeFromFavorites"),disabled:t===e.id,children:l.jsx(I,{})})]})]},e.id))})]}):null};export{Q as default};
