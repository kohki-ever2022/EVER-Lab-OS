import{u as U,m as G,h as V,f as O,e as B,r as y,ad as c,j as e,C as J}from"./index-B-QOVXil.js";import{n as M,t as W,v as X}from"./App-gCA-TVeX.js";const _=()=>{var f,N;const{language:C,currentUser:o,isFacilityStaff:u}=U(),{insuranceCertificates:D}=G(),{companies:E}=V(),{showToast:d}=O(),{addInsuranceCertificate:I,updateInsuranceCertificate:k}=M(),{t:a,isJapanese:T}=B(),[$,m]=y.useState(!1),[s,i]=y.useState({type:c.Liability,status:"PENDING"}),[g,h]=y.useState(null),S=D.filter(t=>u||t.tenantId===(o==null?void 0:o.companyId)).sort((t,n)=>new Date(n.endDate).getTime()-new Date(t.endDate).getTime()),b=t=>{const n=E.find(r=>r.id===t);return n?T?n.nameJP:n.nameEN:t},F=t=>{var r;const n=(r=t.target.files)==null?void 0:r[0];n&&h(n)},p={[c.Fire]:{key:"insuranceTypeFire"},[c.Liability]:{key:"insuranceTypeLiability"},[c.ProductLiability]:{key:"insuranceTypeProductLiability"},[c.WorkersCompensation]:{key:"insuranceTypeWorkersComp"},[c.Other]:{key:"insuranceTypeOther"}},L=t=>{if(t.preventDefault(),!o||!g||!s.insuranceCompany||!s.policyNumber||!s.coverageAmount||!s.startDate||!s.endDate)return;const n=new FileReader;n.readAsDataURL(g),n.onload=async()=>{const r=n.result;try{const l={tenantId:o.companyId,type:s.type,insuranceCompany:s.insuranceCompany,policyNumber:s.policyNumber,coverageAmount:Number(s.coverageAmount),startDate:new Date(s.startDate),endDate:new Date(s.endDate),certificateUrl:r,uploadedDate:new Date,uploadedBy:o.id,status:"PENDING",notes:s.notes},v=a(p[l.type].key),j=b(o.companyId),q=W(J.InsuranceRenewal,{jp:`【重要】${v}更新期限: ${j}`,en:`[Important] ${v} Renewal Deadline: ${j}`},{jp:`保険会社: ${l.insuranceCompany}
証券番号: ${l.policyNumber}
補償額: ¥${l.coverageAmount.toLocaleString()}

※この日までに更新手続きを完了してください。`,en:`Insurance Company: ${l.insuranceCompany}
Policy Number: ${l.policyNumber}
Coverage: ¥${l.coverageAmount.toLocaleString()}

※Please complete renewal by this date.`},l.endDate,480,[l.uploadedBy,"user-lab-manager"],void 0,[129600,43200,10080,0]),x=await X.createEvent(q,C),w=await I({...l,googleCalendarEventId:x.success?x.googleCalendarEventId:void 0});if(w.success===!1){d(`${a("certSaveFailed")}: ${w.error.message}`,"error");return}x.success?d(a("certUploadSuccessCalendar"),"success"):d(a("certUploadWarningNoCalendar"),"warning"),m(!1),i({type:c.Liability,status:"PENDING"}),h(null)}catch(l){console.error("Error uploading certificate:",l),d(a("errorOccurred"),"error")}}},R=async t=>{if(!u||!o)return;const n=await k({...t,status:"VERIFIED",verifiedBy:o.id,verifiedDate:new Date});n.success===!1?d(`${a("verifyFailed")}: ${n.error.message}`,"error"):d(a("certVerified"),"success")},A=t=>{const n=new Date,r=Math.floor((new Date(t).getTime()-n.getTime())/(1e3*60*60*24));return r<0?{status:"expired",label:a("statusExpired"),color:"bg-red-100 text-red-700"}:r<=30?{status:"expiring-soon",label:`${a("daysLeft")}${r}${a("daysLeftSuffix")}`,color:"bg-orange-100 text-orange-700"}:r<=90?{status:"warning",label:`${a("daysLeft")}${r}${a("daysLeftSuffix")}`,color:"bg-yellow-100 text-yellow-700"}:{status:"valid",label:a("valid"),color:"bg-green-100 text-green-700"}},P={PENDING:{key:"pending",color:"bg-yellow-100 text-yellow-700"},VERIFIED:{key:"statusVerified",color:"bg-blue-100 text-blue-700"},EXPIRED:{key:"statusExpired",color:"bg-gray-200 text-gray-600"},REJECTED:{key:"insuranceStatusRejected",color:"bg-red-100 text-red-700"}};return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:a("insuranceManagement")}),(o==null?void 0:o.roleCategory)!=="FACILITY"&&e.jsx("button",{onClick:()=>m(!0),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:a("uploadNew")})]}),$&&e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow mb-6 border-2 border-blue-200",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:a("uploadInsuranceCert")}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:a("insuranceType")}),e.jsx("select",{name:"type",value:s.type,onChange:t=>i({...s,type:t.target.value}),className:"w-full border rounded p-2 mt-1",children:Object.entries(p).map(([t,{key:n}])=>e.jsx("option",{value:t,children:a(n)},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:a("insuranceCompany")}),e.jsx("input",{type:"text",name:"insuranceCompany",value:s.insuranceCompany||"",onChange:t=>i({...s,insuranceCompany:t.target.value}),className:"w-full border rounded p-2 mt-1",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:a("policyNumber")}),e.jsx("input",{type:"text",name:"policyNumber",value:s.policyNumber||"",onChange:t=>i({...s,policyNumber:t.target.value}),className:"w-full border rounded p-2 mt-1",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:a("coverageAmount")}),e.jsx("input",{type:"number",name:"coverageAmount",value:s.coverageAmount||"",onChange:t=>i({...s,coverageAmount:parseFloat(t.target.value)}),className:"w-full border rounded p-2 mt-1",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:a("startDate")}),e.jsx("input",{type:"date",name:"startDate",value:((f=s.startDate)==null?void 0:f.toString().split("T")[0])||"",onChange:t=>i({...s,startDate:new Date(t.target.value)}),className:"w-full border rounded p-2 mt-1",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:a("endDate")}),e.jsx("input",{type:"date",name:"endDate",value:((N=s.endDate)==null?void 0:N.toString().split("T")[0])||"",onChange:t=>i({...s,endDate:new Date(t.target.value)}),className:"w-full border rounded p-2 mt-1",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:a("certFile")}),e.jsx("input",{type:"file",accept:".pdf",onChange:F,className:"w-full border rounded p-2 mt-1",required:!0})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx("button",{type:"button",onClick:()=>m(!1),className:"px-4 py-2 border rounded hover:bg-gray-50",children:a("cancel")}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:a("upload")})]})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[u&&e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:a("tenant")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:a("insuranceType")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:a("policyNumber")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:a("expiryDate")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:a("status")}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:a("actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:S.map(t=>{const n=A(t.endDate),r=P[t.status],l=t.status==="EXPIRED"?n:{label:a(r.key),color:r.color};return e.jsxs("tr",{className:"hover:bg-gray-50",children:[u&&e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:b(t.tenantId)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:a(p[t.type].key)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:t.policyNumber}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:[e.jsx("div",{children:t.endDate.toLocaleDateString()}),e.jsx("div",{className:`text-xs mt-1 font-medium ${n.color}`,children:n.label})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded ${l.color}`,children:l.label})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:[e.jsx("a",{href:t.certificateUrl,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 mr-3",children:a("view")}),u&&t.status==="PENDING"&&e.jsx("button",{onClick:()=>R(t),className:"text-green-600 hover:text-green-800",children:a("verify")})]})]},t.id)})})]})})]})};export{_ as default};
